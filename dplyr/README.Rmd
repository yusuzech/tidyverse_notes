---
title: "README"
author: "Yifu Yan"
date: "3/11/2019"
output: 
    md_document:
    variant: markdown_github
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## 1.Usage of `mutate_all()`, `mutate_if()` and `mutate_at()`

Use scoped variants of `summarise()`, `mutate(`) and `transmute()` when handling many columns. 

1. `.predicate`:
    1. `_at()` variants accepts `vars()` for selecting columns.
    1. `_if()` variants accepts logical conditions for selecting columns.
1. `.funs`:
    1. Use `funs()`, which support renaming new columns
    2. Use function name(e.g. sum,mean)
    3. Use purrr syntax(`~.x`)

```{r}
library(dplyr)
library(rlang)
```


Instead of doing:

```{r}
mtcars %>%
    group_by(cyl) %>%
    transmute(mpg_sum = sum(mpg),
           disp_sum = sum(disp),
           mpg_pct = mpg/sum(mpg),
           disp_pct = disp/sum(disp)) %>%
    head() %>%
    knitr::kable()
```


Do:

```{r}
mtcars %>%
    group_by(cyl) %>%
    transmute_at(vars(mpg,disp),
              funs(sum = sum(.),
                   pct = ./sum(.))) %>%
    head() %>%
    knitr::kable()
```

## 2.Programming with dplyr(variable, argument and string conversions)

When Programming with **tidyverse(dplyr,ggplot)**, we need to make conversions betwwen string, argument and variable frequently. It can be really annoying if we don't know what to do. Luckily,with `rlang` package, we can perform these calculations easily.

```{r}
library(dplyr)
library(rlang)
```

### No functions

#### Convert String to Variable

```{r}
x <- c(1,2,3) 
y <- c("a","b","c")
# convert and evaluate
print(eval_tidy(sym("x")))

# convert a list of string to variable and evaluate
for(v in syms(list("x","y"))){
    print(eval_tidy(v))
}
```

#### Convert variable to string

```{r}
quo(x) %>%
    as_name()

#convert a list of variable to string
for(x in quos(x,y,z)){
    print(as_name(x))
}
```

#### Evaluate string as code
```{r}
#evaluate string as code
print(eval_tidy(parse_expr("sum(c(1,2,3))")))


# one more conversion is required is the string is saved to a variable
x <- "sum(c(1,2,3))"
quo(x) %>%
    eval_tidy() %>%
    parse_expr() %>%
    eval_tidy() %>%
    print()

# evaluate a "list" of string as code
x <- 1
y <- 2
z <- 3
for(arg in parse_exprs("x == 1;y > 1;is.numeric(z)")){
    print(eval_tidy(arg)) # default environment: global_env()
}

# use custom data
for(arg in parse_exprs("x == 1;y > 1;is.numeric(z)")){
    print(eval_tidy(arg,data = list(x=2,y=0,z="a"))) # custom data
}

```

#### Turn code into string

```{r}
x <- 5
quo(x+5) %>% 
    quo_text()

for(arg in quos(x+5,y >2,z != 3)){
    print(quo_text(arg))
}
```



### In functions

#### Turn string into bariable

```{r}
library(dplyr)
library(rlang)

get_avg <- function(g){
    g <- sym(g)
    return(
        iris %>%
            group_by(!!g) %>%
            summarise(avg = mean(Sepal.Length))
    )
}


get_avg("Species")
```
